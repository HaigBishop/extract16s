# The extract16s Tool

The `extract16s` tool extracts specific variable regions from 16S rRNA gene sequences. It uses Hidden Markov Models (HMMs) to align sequences to reference models, then extracts regions defined in a truncation specification file (`.truncspec`). The `.truncspec` file can be manually created or automatically generated by the `asvs2truncspec` tool.

This tool takes full-length 16S sequences, aligns them separately against bacterial and archaeal HMMs, then extracts one or more variable regions (V3, V4, V3-V4, etc.) based on reference sequence positions. It also filters sequences by length and ambiguous base content.


---


## Input Data

### Full Length 16S Sequences
The tool requires a FASTA file containing full-length 16S rRNA gene sequences. Headers must indicate whether sequences are bacterial or archaeal by containing `d__Bacteria` or `d__Archaea`. This is the standard GTDB header format:
```fasta
>GB_GCA_000488855.1~KI535272.1 d__Bacteria;p__Bacillota_A;c__Clostridia;o__Peptostreptococcales;f__Anaerovoracaceae;g__Gallibacter;s__Gallibacter brachus [location=411..1920] [ssu_len=1510] [contig_len=1959]
GGCAGCAGTGGGGAATATTGCACAATGGGGGAAACCCTGATGCAGCAACGCCGCGTGAA...
>GB_GCA_000494145.1~AWOE01000013.1 d__Archaea;p__Thermoproteota;c__Nitrososphaeria_A;o__Caldarchaeales;f__Calditenuaceae;g__Calditenuis;s__Calditenuis sp000494145 [location=10546..12034] [ssu_len=1489] [contig_len=32668]
CGCCCGTAGCCGGCCCGGTGTGTCCCTCGTTAAATCCACGGGCTTAACCCGTGGGCTGC...
```

Sequences not matching either domain pattern are silently skipped during the split step.

### 16S HMMs (Hidden Markov Models)
The tool requires two HMM files for alignment:
- `InputData/bac_16s.hmm`: Bacterial 16S rRNA HMM
- `InputData/arc_16s.hmm`: Archaeal 16S rRNA HMM

These HMM files are taken from the [barrnap](https://github.com/tseemann/barrnap/) tool's [database](https://github.com/tseemann/barrnap/blob/master/db/). They contain profile Hidden Markov Models specifically trained for bacterial and archaeal 16S rRNA genes. The files have been modified to remove non-16S models (5S, 23S, etc.).

### Truncation Specification File (.truncspec)
The `.truncspec` file defines the reference sequence IDs and the regions to extract. Lines starting with `#` are comments and are ignored. The format is:
```truncspec
# 16S Region Truncation Specification File (.truncspec)
ARC_REF_SEQ_ID: RS_GCF_000025685.1~NC_013967.1
BAC_REF_SEQ_ID: RS_GCF_000194175.1~NZ_AEZI02000002.1
V4: arc_start=471, arc_end=724, bac_start=530, bac_end=782, min_len=245, max_len=260
V3-V4: arc_start=336, arc_end=722, bac_start=354, bac_end=780, min_len=385, max_len=445
```

This file must include:
- `ARC_REF_SEQ_ID`: Archaeal reference sequence ID (must exist in the input FASTA)
- `BAC_REF_SEQ_ID`: Bacterial reference sequence ID (must exist in the input FASTA)
- One or more region definitions, each with:
  - Region name (e.g., V4, V3-V4) - used as the output filename prefix
  - `arc_start`, `arc_end`: Start and end positions (1-based, inclusive) in the archaeal reference sequence
  - `bac_start`, `bac_end`: Start and end positions (1-based, inclusive) in the bacterial reference sequence
  - `min_len`, `max_len`: Expected sequence length range after extraction (used for filtering)

The reference sequence IDs must match a substring of a FASTA header in the input file. The positions refer to nucleotide positions in the unaligned reference sequences.


---


## Configuration

The tool is configured entirely via command-line options. There are no configuration files to edit.

### Required Arguments
```bash
bash ./Scripts/extract16s.sh <input_fna> <bac_hmm> <arc_hmm> <trunc_spec_file> [options]
```

- `<input_fna>`: Input FASTA file containing 16S rRNA sequences
- `<bac_hmm>`: Bacterial 16S rRNA HMM file
- `<arc_hmm>`: Archaeal 16S rRNA HMM file
- `<trunc_spec_file>`: Truncation specification file (.truncspec)

### Options

**Processing options:**
- `--skip_align`: Skip alignment process and use existing alignments from the intermediates directory. Use this to re-run truncation/filtering without re-running the slow alignment step.
- `--trunc_padding N`: Add N bases of padding to each side of extracted regions (default: 0). For example, with `--trunc_padding 15` and a region at positions 500-700, the actual extraction is from 485-715.
- `--rm_intermediates`: Remove intermediate files after processing.

**Filtering options:**
- `--no_filter_ambiguous`: Skip filtering by ambiguous base content for all sequences.
- `--no_filter_ambiguous_for_full`: Skip ambiguous base filtering only for full-length sequences (region sequences are still filtered unless `--no_filter_ambiguous` is also used).
- `--no_require_all_regions`: Don't require sequences to be successfully extracted for all regions. By default, a sequence must pass filtering in all regions to be included in any output.

**Output options:**
- `--inter_dir PATH`: Specify the intermediates directory (default: `./Intermediates`)
- `--out_dir PATH`: Specify the output directory (default: `./Output`)
- `--add_indices`: Prepend unique indices (`{1}`, `{2}`, ...) to output FASTA headers. Ignored if `--no_require_all_regions` is used.
- `--verbose`: Print detailed progress information during processing.


---


## Output Data

### Primary Output Files
The tool generates output files in the directory specified by `--out_dir` (default: `./Output/`):

**Passed sequences:**
- `FULL_seqs.fasta`: Full-length sequences that passed all filters
- `{REGION}_seqs.fasta`: Extracted sequences for each region (e.g., `V3_seqs.fasta`, `V3-V4_seqs.fasta`)

**Failed sequences:**
- `failed_FULL_seqs.fasta`: Full-length sequences that failed one or more filtering steps
- `failed_{REGION}_seqs.fasta`: Region sequences corresponding to failed set

The failed region files mirror the headers and order of `failed_FULL_seqs.fasta`. If a sequence failed region extraction (length 0), its sequence line is left empty. This guarantees the file has the same number of lines as `failed_FULL_seqs.fasta`.

**Summary:**
- `about_extraction.txt`: Summary of processing details

### Header Indexing
If `--add_indices` is used (and `--no_require_all_regions` is not), output FASTA headers are prepended with unique indices:
```fasta
>{1}GB_GCA_000488855.1~KI535272.1 d__Bacteria;p__Bacillota_A;...
GGCAGCAGTGGGGAATATTGCACAATGGGGGAAACCCTGATGCAGCAACGCCGCGTGAA...
>{2}GB_GCA_000494145.1~AWOE01000013.1 d__Archaea;p__Thermoproteota;...
CGCCCGTAGCCGGCCCGGTGTGTCCCTCGTTAAATCCACGGGCTTAACCCGTGGGCTGC...
```

This enables downstream tools to associate sequences across files by index.

### Cross-Region Filtering Behavior
By default (`--no_require_all_regions` not set), a sequence must pass all filters for all regions to appear in any output file. This ensures:
- All output files contain the same set of sequences
- Headers appear in the same order across all files
- Each sequence has a valid extraction in every region

If `--no_require_all_regions` is set, each file contains whichever sequences passed that file's filters, and files may have different sequence sets.

### Summary File Contents
The `about_extraction.txt` file includes:
- Input parameters and options used
- Reference sequence IDs and region parameters (with padding applied)
- Filtering breakdown by domain (bacteria/archaea) and failure reason
- Sequence length statistics (min, 5%, median, 95%, max)
- Processing timestamp


---


## Pipeline

The tool processes sequences through a linear pipeline. Intermediate files are written to the intermediates directory (default: `./Intermediates/`).

### Processing Overview
1. Split input sequences into bacterial and archaeal sets based on header content
2. Align each set to its corresponding HMM using `hmmalign`
3. Convert alignments to A2M format using `esl-reformat`
4. For each region, extract the specified range from each alignment
5. Merge bacterial and archaeal extractions, preserving original FASTA order
6. Filter sequences by length and ambiguous base content
7. Apply cross-region filtering (unless `--no_require_all_regions`)
8. Write final output files

### Step 1: Split Sequences by Domain
The input FASTA is split into two files:
- `00_full_seqs_bac.fna`: Sequences with `d__Bacteria` in header
- `00_full_seqs_arc.fna`: Sequences with `d__Archaea` in header

### Step 2: HMM Alignment
Each domain's sequences are aligned to the corresponding HMM using HMMER's `hmmalign`:
```bash
hmmalign -o 01_align_bac_ssu.sto $bac_hmm 00_full_seqs_bac.fna
hmmalign -o 01_align_arc_ssu.sto $arc_hmm 00_full_seqs_arc.fna
```

The alignment step is the slowest part of the pipeline (approximately 90 minutes for a large database). Use `--skip_align` to reuse existing alignments when re-running.

### Step 3: Format Conversion
Alignments are converted from Stockholm to A2M format:
```bash
esl-reformat --informat stockholm -d -o 01_align_bac_ssu.a2m a2m 01_align_bac_ssu.sto
esl-reformat --informat stockholm -d -o 01_align_arc_ssu.a2m a2m 01_align_arc_ssu.sto
```

A2M format uses uppercase letters for match states (HMM positions) and lowercase letters for insert states. This distinction is critical for the extraction logic.

### Step 4: Region Extraction
For each region defined in the `.truncspec` file:

**Finding alignment indices:**

The `.truncspec` positions refer to nucleotide positions in the reference sequence. These must be converted to alignment column indices. The conversion walks the reference sequence's aligned form:
- Alignment position increments on uppercase letters and gaps (`-`)
- Nucleotide position increments on any letter (uppercase or lowercase)
- When nucleotide position equals the target start/end, record the alignment position

**Extracting from all sequences:**

For each sequence in the alignment, extract characters between the alignment start and end indices:
- Only uppercase letters and gaps count toward alignment position
- Output only letters (skip gaps), converting all to uppercase
- The result is the unaligned extracted region

Intermediate files:
- `02_truncated_bac_{REGION}.fna`: Bacterial extractions
- `02_truncated_arc_{REGION}.fna`: Archaeal extractions

### Step 5: Merge and Reorder
Bacterial and archaeal extractions are merged and reordered to match the original input FASTA order:
- `03_joined_truncated_{REGION}.fna`: Simple concatenation
- `04_reordered_truncated_{REGION}.fna`: Sorted by original order

### Step 6: Per-Region Filtering
Each region's sequences are filtered by:
- **Extraction success**: Sequences with length 0 (extraction failed) are removed
- **Length**: Sequences outside `[min_len + 2*padding, max_len + 2*padding]` are removed
- **Ambiguous bases**: Sequences containing non-ATCG characters are removed (unless `--no_filter_ambiguous`)

Output: `05_filtered_truncated_{REGION}.fna`

Full-length sequences are also filtered:
- **Ambiguous bases**: Removed unless `--no_filter_ambiguous` or `--no_filter_ambiguous_for_full`

Output: `06_filtered_full_seqs.fna`

### Step 7: Cross-Region Filtering
If `--no_require_all_regions` is NOT set:
- Extract accession IDs from each filtered file
- Compute intersection of all accession ID sets
- Keep only sequences present in all filtered files

This ensures output files are synchronized (same sequences, same order).

### Step 8: Write Outputs
Final files are written to the output directory:
- Passed sequences go to `FULL_seqs.fasta` and `{REGION}_seqs.fasta`
- Failed sequences go to `failed_FULL_seqs.fasta` and `failed_{REGION}_seqs.fasta`
- Summary goes to `about_extraction.txt`

### Intermediate Directory Structure
```
Intermediates/
├── 00_full_seqs_bac.fna          # Split bacterial sequences
├── 00_full_seqs_arc.fna          # Split archaeal sequences
├── 01_align_bac_ssu.sto          # Bacterial alignment (Stockholm)
├── 01_align_bac_ssu.a2m          # Bacterial alignment (A2M)
├── 01_align_arc_ssu.sto          # Archaeal alignment (Stockholm)
├── 01_align_arc_ssu.a2m          # Archaeal alignment (A2M)
├── 02_truncated_bac_{REGION}.fna # Bacterial region extractions
├── 02_truncated_arc_{REGION}.fna # Archaeal region extractions
├── 03_joined_truncated_{REGION}.fna    # Merged extractions
├── 04_reordered_truncated_{REGION}.fna # Reordered extractions
├── 05_filtered_truncated_{REGION}.fna  # Filtered region sequences
├── 06_filtered_full_seqs.fna           # Filtered full sequences
├── stats_{REGION}.txt            # Per-region filter statistics
└── stats_full.txt                # Full sequence filter statistics
```


---


## Usage Guide

### Preparing Input Files
Before running, ensure all input files use Unix line endings:
```bash
find . -type f -name "*.fna" -exec dos2unix {} +
find . -type f -name "*.hmm" -exec dos2unix {} +
find . -type f -name "*.truncspec" -exec dos2unix {} +
```

### Basic Usage
```bash
bash ./Scripts/extract16s.sh \
     ./InputData/ssu_all_r220_filtered.fna \
     ./InputData/bac_16s.hmm \
     ./InputData/arc_16s.hmm \
     ./InputData/my_regions.truncspec \
     --verbose
```

### Adding Padding
Padding extends the extraction boundaries, capturing flanking sequence:
```bash
bash ./Scripts/extract16s.sh \
     ./InputData/ssu_all_r220_filtered.fna \
     ./InputData/bac_16s.hmm \
     ./InputData/arc_16s.hmm \
     ./InputData/my_regions.truncspec \
     --trunc_padding 15 \
     --verbose
```

With `--trunc_padding 15`, a region specified as positions 500-700 extracts positions 485-715.

### Re-running with Existing Alignments
The alignment step takes approximately 90 minutes. To iterate on filtering parameters without re-aligning:
```bash
# First run (full pipeline)
bash ./Scripts/extract16s.sh \
     ./InputData/ssu_all_r220_filtered.fna \
     ./InputData/bac_16s.hmm \
     ./InputData/arc_16s.hmm \
     ./InputData/my_regions.truncspec \
     --verbose

# Subsequent runs (skip alignment, ~2 minutes)
bash ./Scripts/extract16s.sh \
     ./InputData/ssu_all_r220_filtered.fna \
     ./InputData/bac_16s.hmm \
     ./InputData/arc_16s.hmm \
     ./InputData/my_regions.truncspec \
     --skip_align \
     --verbose
```

### Custom Output Directories
```bash
bash ./Scripts/extract16s.sh \
     ./InputData/ssu_all_r220_filtered.fna \
     ./InputData/bac_16s.hmm \
     ./InputData/arc_16s.hmm \
     ./InputData/my_regions.truncspec \
     --inter_dir ./my_intermediates \
     --out_dir ./my_output \
     --verbose
```

### Production Run (Clean Up Intermediates)
```bash
bash ./Scripts/extract16s.sh \
     ./InputData/ssu_all_r220_filtered.fna \
     ./InputData/bac_16s.hmm \
     ./InputData/arc_16s.hmm \
     ./InputData/my_regions.truncspec \
     --trunc_padding 15 \
     --rm_intermediates \
     --add_indices \
     --verbose
```

### Disabling Ambiguous Base Filtering
For exploratory analysis where you want to retain sequences with ambiguous bases:
```bash
# Skip ambiguous filtering entirely
bash ./Scripts/extract16s.sh ... --no_filter_ambiguous

# Skip only for full-length (regions still filtered)
bash ./Scripts/extract16s.sh ... --no_filter_ambiguous_for_full
```

### Independent Region Outputs
By default, a sequence must pass all regions to appear anywhere. To allow independent outputs:
```bash
bash ./Scripts/extract16s.sh ... --no_require_all_regions
```

Note: `--add_indices` is incompatible with this option.


---


## Coordinate Conventions

**Reference positions in `.truncspec`:** 1-based, inclusive nucleotide positions in the unaligned reference sequence.

**Alignment positions:** 1-based column indices in the A2M alignment. Only uppercase characters and gaps count as alignment positions; lowercase (insert state) characters do not.

**Length calculations:** Inclusive. A region from position 500 to 700 has length `700 - 500 + 1 = 201`.


---


## Dependencies

- **HMMER suite**: Provides `hmmalign` and `esl-reformat`. Available from [http://hmmer.org/](http://hmmer.org/)
- **Unix tools**: `awk`, `bc`, `grep`, `sed`, `tr`

The script checks for required dependencies at startup and reports any missing tools.


---


## Troubleshooting

**"Reference sequence ID not found in input FASTA"**
- The `ARC_REF_SEQ_ID` or `BAC_REF_SEQ_ID` from the `.truncspec` must appear as a substring in a FASTA header
- Check for typos or accession version mismatches

**"Bacterial/Archaeal alignment file does not exist"**
- Run without `--skip_align` to generate alignments
- Ensure HMM files are valid and in correct format

**Many sequences failing extraction (length 0)**
- Check that `.truncspec` positions are within valid range for the reference sequences
- Verify reference sequences are full-length 16S

**Many sequences failing length filter**
- Review `min_len`/`max_len` in the `.truncspec` - they may be too restrictive
- Account for `--trunc_padding` when setting length bounds (effective bounds are `min_len + 2*padding` to `max_len + 2*padding`)

**Many sequences failing ambiguous base filter**
- This is often expected for raw database sequences
- Use `--no_filter_ambiguous` for exploratory analysis
- Use `--no_filter_ambiguous_for_full` to only filter region sequences

**Output files have different numbers of sequences**
- This happens when using `--no_require_all_regions`
- Without this flag, all output files are synchronized


---


## Performance

- **Full run (with alignment):** ~90 minutes for a large 16S database
- **Re-run (skip alignment):** ~2 minutes
- **Memory usage:** Proportional to input file size

The alignment step dominates runtime. Use `--skip_align` when iterating on extraction or filtering parameters.
